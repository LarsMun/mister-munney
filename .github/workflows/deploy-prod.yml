name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  # Run CI checks first (on GitHub-hosted runner)
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted
    needs: ci  # Only deploy if CI passes

    steps:
      - name: üìã Pre-deployment checklist
        run: |
          echo "üöÄ Starting Production Deployment"
          echo "Target: https://munney.munne.me"
          echo "Location: /srv/munney-prod"
          
      - name: üíæ Create database backup
        run: |
          cd /srv/munney-prod
          source .env
          BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
          echo "Creating backup: munney_prod_${BACKUP_DATE}.sql"
          if docker ps | grep -q munney-prod-mysql; then
            docker exec munney-prod-mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD_PROD} money_db_prod > /srv/munney-prod/backups/munney_prod_${BACKUP_DATE}.sql 2>/dev/null || true
            echo "‚úÖ Backup created"
          else
            echo "‚ö†Ô∏è  Database not running, skipping backup"
          fi
          
      - name: üì• Pull latest code from main
        run: |
          cd /srv/munney-prod
          git fetch origin
          git checkout main
          git pull origin main
          echo "‚úÖ Code updated to latest main branch"

      - name: üîê Generate JWT keys
        run: |
          cd /srv/munney-prod/backend
          if [ ! -f config/jwt/private.pem ]; then
            echo "Generating JWT RSA keys..."
            mkdir -p config/jwt
            source ../.env
            # Generate private key with passphrase
            openssl genpkey -algorithm RSA \
              -out config/jwt/private.pem \
              -aes256 \
              -pass pass:"${JWT_PASSPHRASE}" \
              -pkeyopt rsa_keygen_bits:4096
            # Generate public key from private key
            openssl rsa \
              -pubout \
              -in config/jwt/private.pem \
              -out config/jwt/public.pem \
              -passin pass:"${JWT_PASSPHRASE}"
            chmod 644 config/jwt/private.pem config/jwt/public.pem
            echo "‚úÖ JWT keys generated"
          else
            echo "‚úÖ JWT keys already exist"
          fi

      - name: üèóÔ∏è  Build production images
        run: |
          cd /srv/munney-prod
          echo "Building with no-cache for clean build..."
          docker compose -f deploy/ubuntu/docker-compose.prod.yml build --no-cache
          echo "‚úÖ Images built"
          
      - name: üîÑ Deploy containers
        run: |
          cd /srv/munney-prod
          docker compose -f deploy/ubuntu/docker-compose.prod.yml down
          docker compose -f deploy/ubuntu/docker-compose.prod.yml up -d
          echo "‚úÖ Containers deployed"
          
      - name: ‚è≥ Wait for services
        run: |
          echo "Waiting 20 seconds for services to stabilize..."
          sleep 20
          
      - name: üóÑÔ∏è Run database migrations
        run: |
          cd /srv/munney-prod
          docker exec munney-prod-backend php bin/console doctrine:migrations:migrate --no-interaction --env=prod
          echo "‚úÖ Migrations complete"
          
      - name: üßπ Clear and warm cache
        run: |
          cd /srv/munney-prod
          docker exec munney-prod-backend php bin/console cache:clear --env=prod
          docker exec munney-prod-backend php bin/console cache:warmup --env=prod
          echo "‚úÖ Cache refreshed"
          
      - name: üè• Health check
        run: |
          echo "Running health checks..."
          sleep 5
          if curl -f -s https://munney.munne.me/ > /dev/null; then
            echo "‚úÖ Frontend responding"
          else
            echo "‚ö†Ô∏è  Frontend check failed"
            exit 1
          fi
          if curl -f -s https://munney.munne.me/api/doc.json > /dev/null; then
            echo "‚úÖ Backend API responding"
          else
            echo "‚ö†Ô∏è  Backend API check failed"
            exit 1
          fi
          
      - name: ‚úÖ Deployment complete
        run: |
          echo "========================================"
          echo "‚úÖ Production deployment successful!"
          echo "========================================"
          echo "üåê URL: https://munney.munne.me"
          docker ps --filter 'label=project=munney' --filter 'label=environment=production'
