name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  # Run CI checks first (on GitHub-hosted runner)
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted
    needs: ci  # Only deploy if CI passes

    steps:
      - name: ğŸ“‹ Pre-deployment checklist
        run: |
          echo "ğŸš€ Starting Production Deployment"
          echo "Target: https://munney.munne.me"
          echo "Location: /srv/munney-prod"
          
      - name: ğŸ’¾ Create database backup
        run: |
          cd /srv/munney-prod
          source .env
          BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
          echo "Creating backup: munney_prod_${BACKUP_DATE}.sql"
          if docker ps | grep -q munney-prod-mysql; then
            docker exec munney-prod-mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD_PROD} money_db_prod > /srv/munney-prod/backups/munney_prod_${BACKUP_DATE}.sql 2>/dev/null || true
            echo "âœ… Backup created"
          else
            echo "âš ï¸  Database not running, skipping backup"
          fi
          
      - name: ğŸ“¥ Pull latest code from main
        run: |
          cd /srv/munney-prod
          git fetch origin
          git checkout main
          git pull origin main
          echo "âœ… Code updated to latest main branch"

      - name: ğŸ” Generate JWT keys
        run: |
          cd /srv/munney-prod/backend
          if [ ! -f config/jwt/private.pem ]; then
            echo "Generating JWT RSA keys..."
            mkdir -p config/jwt
            source ../.env
            # Generate private key with passphrase
            openssl genpkey -algorithm RSA \
              -out config/jwt/private.pem \
              -aes256 \
              -pass pass:"${JWT_PASSPHRASE}" \
              -pkeyopt rsa_keygen_bits:4096
            # Generate public key from private key
            openssl rsa \
              -pubout \
              -in config/jwt/private.pem \
              -out config/jwt/public.pem \
              -passin pass:"${JWT_PASSPHRASE}"
            chmod 644 config/jwt/private.pem config/jwt/public.pem
            echo "âœ… JWT keys generated"
          else
            echo "âœ… JWT keys already exist"
          fi

      - name: ğŸ“¸ Tag current images for rollback
        run: |
          cd /srv/munney-prod
          echo "Tagging current images for potential rollback..."
          if docker images | grep -q "munney-prod-backend.*latest"; then
            docker tag munney-prod-backend:latest munney-prod-backend:rollback || true
            echo "âœ… Backend image tagged for rollback"
          fi
          if docker images | grep -q "munney-prod-frontend.*latest"; then
            docker tag munney-prod-frontend:latest munney-prod-frontend:rollback || true
            echo "âœ… Frontend image tagged for rollback"
          fi

      - name: ğŸ—ï¸  Build production images
        run: |
          cd /srv/munney-prod
          echo "Building with no-cache for clean build..."
          docker compose -f deploy/ubuntu/docker-compose.prod.yml build --no-cache
          echo "âœ… Images built"

      - name: ğŸ”„ Deploy containers
        run: |
          cd /srv/munney-prod
          docker compose -f deploy/ubuntu/docker-compose.prod.yml down
          docker compose -f deploy/ubuntu/docker-compose.prod.yml up -d
          echo "âœ… Containers deployed"
          
      - name: â³ Wait for services
        run: |
          echo "Waiting 20 seconds for services to stabilize..."
          sleep 20
          
      - name: ğŸ—„ï¸ Run database migrations
        run: |
          cd /srv/munney-prod
          docker exec munney-prod-backend php bin/console doctrine:migrations:migrate --no-interaction --env=prod
          echo "âœ… Migrations complete"
          
      - name: ğŸ§¹ Clear and warm cache
        run: |
          cd /srv/munney-prod
          docker exec munney-prod-backend php bin/console cache:clear --env=prod
          docker exec munney-prod-backend php bin/console cache:warmup --env=prod
          echo "âœ… Cache refreshed"
          
      - name: ğŸ¥ Health check
        id: health-check
        run: |
          echo "Running health checks..."
          sleep 5
          if curl -f -s https://munney.munne.me/ > /dev/null; then
            echo "âœ… Frontend responding"
          else
            echo "âš ï¸  Frontend check failed"
            exit 1
          fi
          if curl -f -s https://munney.munne.me/api/health > /dev/null; then
            echo "âœ… Backend API responding"
          else
            echo "âš ï¸  Backend API check failed"
            exit 1
          fi

      - name: ğŸ”™ Rollback on failure
        if: failure() && steps.health-check.outcome == 'failure'
        run: |
          echo "âŒ Deployment failed, initiating rollback..."
          cd /srv/munney-prod
          chmod +x deploy/ubuntu/rollback.sh
          ./deploy/ubuntu/rollback.sh

      - name: âœ… Deployment complete
        run: |
          echo "========================================"
          echo "âœ… Production deployment successful!"
          echo "========================================"
          echo "ğŸŒ URL: https://munney.munne.me"
          docker ps --filter 'label=project=munney' --filter 'label=environment=production'
