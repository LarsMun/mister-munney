name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger optie

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“‹ Pre-deployment checklist
        run: |
          echo "ğŸš€ Starting Production Deployment"
          echo "Target: https://munney.home.munne.me"
          echo "Location: /srv/munney-prod"
          
      - name: ğŸ’¾ Create database backup
        run: |
          cd /srv/munney-prod
          BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
          echo "Creating backup: munney_prod_${BACKUP_DATE}.sql"
          if docker ps | grep -q munney-mysql-prod; then
            docker exec munney-mysql-prod mysqldump -u root -p${MYSQL_ROOT_PASSWORD_PROD} money_db_prod > /srv/munney-prod/backups/munney_prod_${BACKUP_DATE}.sql 2>/dev/null || true
            echo "âœ… Backup created"
          else
            echo "âš ï¸  Database not running, skipping backup"
          fi
          
      - name: ğŸ“¥ Pull latest code from main
        run: |
          cd /srv/munney-prod
          git fetch origin
          git checkout main
          git pull origin main
          echo "âœ… Code updated to latest main branch"
          
      - name: ğŸ—ï¸  Build production images
        run: |
          cd /srv/munney-prod
          echo "Building with no-cache for clean build..."
          docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml build --no-cache
          echo "âœ… Images built"
          
      - name: ğŸ”„ Deploy containers
        run: |
          cd /srv/munney-prod
          docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml down
          docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml up -d
          echo "âœ… Containers deployed"
          
      - name: â³ Wait for services
        run: |
          echo "Waiting 20 seconds for services to stabilize..."
          sleep 20
          
      - name: ğŸ—„ï¸ Run database migrations
        run: |
          cd /srv/munney-prod
          docker exec munney-backend-prod php bin/console doctrine:migrations:migrate --no-interaction --env=prod
          echo "âœ… Migrations complete"
          
      - name: ğŸ§¹ Clear and warm cache
        run: |
          cd /srv/munney-prod
          docker exec munney-backend-prod php bin/console cache:clear --env=prod
          docker exec munney-backend-prod php bin/console cache:warmup --env=prod
          echo "âœ… Cache refreshed"
          
      - name: ğŸ¥ Health check
        run: |
          echo "Running health checks..."
          sleep 5
          if curl -f -s https://munney.home.munne.me/ > /dev/null; then
            echo "âœ… Frontend responding"
          else
            echo "âš ï¸  Frontend check failed"
            exit 1
          fi
          if curl -f -s https://munney.home.munne.me/api > /dev/null; then
            echo "âœ… Backend API responding"
          else
            echo "âš ï¸  Backend API check failed"
            exit 1
          fi
          
      - name: âœ… Deployment complete
        run: |
          echo "========================================"
          echo "âœ… Production deployment successful!"
          echo "========================================"
          echo "ğŸŒ URL: https://munney.home.munne.me"
          echo "ğŸ“Š View logs: docker logs munney-backend-prod -f"
