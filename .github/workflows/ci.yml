name: CI - Tests & Quality Checks

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  workflow_call:  # Allow this workflow to be called by other workflows

jobs:
  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_pgsql, intl, zip
          coverage: none

      - name: ğŸ“¦ Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ğŸ“¦ Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: âœ… Symfony requirements check
        run: composer check-platform-reqs

      - name: ğŸ” Check for security vulnerabilities
        run: composer audit

      - name: ğŸ“‹ Validate composer.json
        run: composer validate 2>&1 | grep -q "valid for simple usage" && echo "âœ… composer.json valid" || composer validate

      - name: ğŸ§ª Run PHPUnit tests
        run: |
          if [ -d "tests" ] && [ "$(find tests -name '*Test.php' | head -1)" ]; then
            ./vendor/bin/phpunit --testdox
          else
            echo "â„¹ï¸  No tests found, skipping PHPUnit"
          fi
        env:
          APP_ENV: test

      - name: ğŸ”¬ Check Symfony container
        run: |
          php bin/console lint:container --env=test || echo "âš ï¸ Container check skipped (may need database)"
        env:
          APP_ENV: test
          DATABASE_URL: "sqlite:///:memory:"

  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript type check
        run: npx tsc --noEmit

      - name: ğŸ§¹ ESLint check
        run: npm run lint

      - name: ğŸ—ï¸ Build check
        run: npm run build
        env:
          VITE_API_URL: "https://example.com/api"

  # This job runs after both checks pass and signals success
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [backend-checks, frontend-checks]
    steps:
      - name: âœ… All checks passed
        run: echo "All CI checks passed successfully!"
