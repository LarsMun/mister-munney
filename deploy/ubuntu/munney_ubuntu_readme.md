# Munney Ubuntu Deployment Guide

Complete deployment setup for Munney on Ubuntu server with Traefik reverse proxy.

## Architecture

```
â”œâ”€â”€ Development: https://dev.munney.example.com
â”‚   â”œâ”€â”€ Location: /srv/munney-dev
â”‚   â”œâ”€â”€ Branch: develop
â”‚   â”œâ”€â”€ Database: munney-mysql-dev (port 3334)
â”‚   â””â”€â”€ Network: proxy + munney-dev-internal
â”‚
â””â”€â”€ Production: https://munney.example.com
    â”œâ”€â”€ Location: /srv/munney-prod
    â”œâ”€â”€ Branch: main
    â”œâ”€â”€ Database: munney-mysql-prod (port 3333)
    â””â”€â”€ Network: proxy + munney-prod-internal
```

## Prerequisites

- âœ… Ubuntu 24.04 LTS
- âœ… Docker & Docker Compose installed
- âœ… Traefik running with `proxy` network
- âœ… DNS records pointing to server:
  - `dev.munney.example.com` â†’ YOUR_SERVER_IP
  - `munney.example.com` â†’ YOUR_SERVER_IP

## Initial Setup

### 1. Run Setup Script

From your **development machine** (where you have the code):

```bash
# Copy setup script to server
scp deploy/ubuntu/setup-server.sh user@your-server:/tmp/

# SSH into server
ssh user@your-server

# Run setup
bash /tmp/setup-server.sh
```

This script will:
- âœ… Create Docker proxy network
- âœ… Create project directories (`/srv/munney-dev` and `/srv/munney-prod`)
- âœ… Generate SSH keys for GitHub
- âœ… Clone repositories (develop â†’ dev, main â†’ prod)
- âœ… Generate random passwords and secrets
- âœ… Create `.env` files

### 2. Add SSH Key to GitHub

The setup script will display your SSH public key. Add it to GitHub:

1. Go to https://github.com/settings/keys
2. Click "New SSH key"
3. Title: `your-server-munney`
4. Paste the key shown by the setup script
5. Save

## Deployment

### Deploy Development

```bash
ssh user@your-server
cd /srv/munney-dev
bash deploy/ubuntu/deploy-dev.sh
```

Access: https://devmunney.home.example.com

### Deploy Production

```bash
ssh user@your-server
cd /srv/munney-prod
bash deploy/ubuntu/deploy-prod.sh
```

Access: https://munney.home.example.com

âš ï¸ **Production deployment includes:**
- Automatic database backup before deployment
- Git pull from `main` branch
- Full cache rebuild
- Health check after deployment

## Environment Variables

### Development (.env in /srv/munney-dev)

```bash
MYSQL_ROOT_PASSWORD_DEV=xxx
MYSQL_PASSWORD_DEV=xxx
APP_SECRET_DEV=xxx
```

### Production (.env in /srv/munney-prod)

```bash
MYSQL_ROOT_PASSWORD_PROD=xxx
MYSQL_PASSWORD_PROD=xxx
APP_SECRET_PROD=xxx
```

Auto-generated by setup script. Stored securely on server.

## Database Access

### Development

```bash
# Via Docker
docker exec -it munney-mysql-dev mysql -u money -p
# Password from /srv/munney-dev/.env

# Via external tool (MySQL Workbench, etc.)
Host: your-server (or YOUR_SERVER_IP)
Port: 3334
User: money
Password: [from .env]
Database: money_db_dev
```

### Production

```bash
# Via Docker
docker exec -it munney-mysql-prod mysql -u money -p
# Password from /srv/munney-prod/.env

# Via external tool
Host: your-server (or YOUR_SERVER_IP)
Port: 3333
User: money
Password: [from .env]
Database: money_db_prod
```

## Useful Commands

### View Logs

```bash
# Development
docker logs munney-backend-dev -f
docker logs munney-frontend-dev -f
docker logs munney-mysql-dev -f

# Production
docker logs munney-backend-prod -f
docker logs munney-frontend-prod -f
docker logs munney-mysql-prod -f
```

### Container Status

```bash
# Development
cd /srv/munney-dev
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.dev.yml ps

# Production
cd /srv/munney-prod
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml ps
```

### Shell Access

```bash
# Backend containers
docker exec -it munney-backend-dev bash
docker exec -it munney-backend-prod bash

# Run Symfony commands
docker exec munney-backend-dev php bin/console cache:clear
docker exec munney-backend-prod php bin/console doctrine:migrations:status
```

### Restart Services

```bash
# Development
cd /srv/munney-dev
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.dev.yml restart

# Production
cd /srv/munney-prod
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml restart
```

### Stop/Start

```bash
# Stop
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.dev.yml down
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml down

# Start
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.dev.yml up -d
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml up -d
```

## Database Backups

### Manual Backup

```bash
# Production
DATE=$(date +%Y%m%d_%H%M%S)
docker exec munney-mysql-prod mysqldump -u root -p[PASSWORD] money_db_prod > /srv/munney-prod/backups/munney_prod_${DATE}.sql

# Development
DATE=$(date +%Y%m%d_%H%M%S)
docker exec munney-mysql-dev mysqldump -u root -p[PASSWORD] money_db_dev > /srv/munney-dev/backups/munney_dev_${DATE}.sql
```

### Restore Backup

```bash
# Production
docker exec -i munney-mysql-prod mysql -u root -p[PASSWORD] money_db_prod < /srv/munney-prod/backups/backup_file.sql

# Development
docker exec -i munney-mysql-dev mysql -u root -p[PASSWORD] money_db_dev < /srv/munney-dev/backups/backup_file.sql
```

### Automated Backups (Optional)

Create a cron job:

```bash
# Edit crontab
crontab -e

# Add daily backup at 2 AM
0 2 * * * docker exec munney-mysql-prod mysqldump -u root -p$(grep MYSQL_ROOT_PASSWORD_PROD /srv/munney-prod/.env | cut -d '=' -f2) money_db_prod > /srv/munney-prod/backups/munney_prod_$(date +\%Y\%m\%d).sql

# Keep only last 30 days
0 3 * * * find /srv/munney-prod/backups -name "munney_prod_*.sql" -mtime +30 -delete
```

## SSL Certificates

Traefik automatically handles SSL certificates via Let's Encrypt (TransIP DNS challenge).

Certificates are stored in: `/srv/traefik/acme/acme.json`

To check certificate status:
```bash
docker logs traefik-traefik-1 | grep -i "munney"
```

## Troubleshooting

### Frontend Can't Connect to Backend

Check CORS settings in backend `.env`:

```bash
# Development
CORS_ALLOW_ORIGIN='^https?://(devmunney\.home\.munne\.me|localhost)(:[0-9]+)?$'

# Production
CORS_ALLOW_ORIGIN='^https://munney\.home\.munne\.me$'
```

### Traefik Not Routing

Check container labels:
```bash
docker inspect munney-frontend-dev | grep -A 20 Labels
docker inspect munney-backend-dev | grep -A 20 Labels
```

Verify containers are on proxy network:
```bash
docker network inspect proxy | grep munney
```

### Database Connection Failed

Check if database container is healthy:
```bash
docker ps | grep munney-mysql
```

Check logs:
```bash
docker logs munney-mysql-dev
docker logs munney-mysql-prod
```

Test connection from backend:
```bash
docker exec munney-backend-dev php bin/console dbal:run-sql "SELECT 1"
```

### Clear Everything and Restart

```bash
# Development
cd /srv/munney-dev
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.dev.yml down -v
bash deploy/ubuntu/deploy-dev.sh

# Production (âš ï¸ CAREFUL - this deletes data!)
cd /srv/munney-prod
docker compose -f docker-compose.yml -f deploy/ubuntu/docker-compose.prod.yml down -v
bash deploy/ubuntu/deploy-prod.sh
```

## Monitoring

### Check Service Health

```bash
# Frontend
curl -I https://devmunney.home.example.com
curl -I https://munney.home.example.com

# Backend API
curl -I https://devmunney.home.example.com/api
curl -I https://munney.home.example.com/api
```

### Docker Stats

```bash
docker stats munney-backend-dev munney-frontend-dev munney-mysql-dev
docker stats munney-backend-prod munney-frontend-prod munney-mysql-prod
```

## Updates

### Update Development

```bash
cd /srv/munney-dev
bash deploy/ubuntu/deploy-dev.sh
```

### Update Production

```bash
cd /srv/munney-prod
bash deploy/ubuntu/deploy-prod.sh
```

The deploy scripts automatically:
- Pull latest code from GitHub
- Rebuild Docker images
- Run database migrations
- Clear and warm up cache
- Create backup (production only)

## Security Notes

- ğŸ”’ All passwords are auto-generated and stored in `.env` files
- ğŸ”’ `.env` files are NOT in git (listed in `.gitignore`)
- ğŸ”’ Backend volumes are read-only in production
- ğŸ”’ HTTPS enforced via Traefik with Let's Encrypt
- ğŸ”’ Security headers added via Traefik labels
- ğŸ”’ Database ports exposed only for external tools (can be removed)

## File Structure

```
/srv/
â”œâ”€â”€ munney-dev/
â”‚   â”œâ”€â”€ .env                    # Environment variables
â”‚   â”œâ”€â”€ .git/                   # Git repository (develop branch)
â”‚   â”œâ”€â”€ backend/
â”‚   â”‚   â”œâ”€â”€ .env                # Symfony config
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ deploy/ubuntu/          # Deployment scripts
â”‚   â”œâ”€â”€ backups/                # Database backups
â”‚   â””â”€â”€ docker-compose.yml
â”‚
â””â”€â”€ munney-prod/
    â”œâ”€â”€ .env                    # Environment variables
    â”œâ”€â”€ .git/                   # Git repository (main branch)
    â”œâ”€â”€ backend/
    â”‚   â”œâ”€â”€ .env                # Symfony config
    â”‚   â”œâ”€â”€ src/
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ frontend/
    â”‚   â”œâ”€â”€ src/
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ deploy/ubuntu/          # Deployment scripts
    â”œâ”€â”€ backups/                # Database backups
    â””â”€â”€ docker-compose.yml
```

## Support

For issues or questions:
- Check logs: `docker logs [container-name] -f`
- Check Traefik dashboard: https://traefik.home.example.com
- Verify DNS: `ping devmunney.home.example.com`
- Test SSL: `curl -I https://munney.home.example.com`