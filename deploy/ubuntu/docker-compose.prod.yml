# Munney Production Environment
# Standalone production configuration - no base file needed
# Usage: docker compose -f deploy/ubuntu/docker-compose.prod.yml up -d

services:
  munney-prod-backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile.prod
    container_name: munney-prod-backend
    restart: unless-stopped
    networks:
      - proxy
      - munney-prod-network
    depends_on:
      munney-prod-mysql:
        condition: service_healthy
    environment:
      APP_ENV: prod
      APP_DEBUG: "false"
      DATABASE_URL: "mysql://money:${MYSQL_PASSWORD_PROD}@munney-prod-mysql:3306/money_db_prod?serverVersion=8.0&charset=utf8mb4"
      CORS_ALLOW_ORIGIN: '^https://munney\.munne\.me$'
      APP_SECRET: ${APP_SECRET_PROD}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      JWT_SECRET_KEY: /var/www/html/config/jwt/private.pem
      JWT_PUBLIC_KEY: /var/www/html/config/jwt/public.pem
      JWT_PASSPHRASE: ${JWT_PASSPHRASE_PROD}
      LOCK_DSN: flock
    # NO VOLUMES IN PRODUCTION - use the built image
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # HTTPS router
      - "traefik.http.routers.munney-prod-backend.rule=Host(`munney.munne.me`) && PathPrefix(`/api`)"
      - "traefik.http.routers.munney-prod-backend.entrypoints=websecure"
      - "traefik.http.routers.munney-prod-backend.tls=true"
      - "traefik.http.routers.munney-prod-backend.tls.certresolver=le"
      - "traefik.http.routers.munney-prod-backend.service=munney-prod-backend"
      - "traefik.http.routers.munney-prod-backend.middlewares=munney-security"

      # HTTP router - redirects to HTTPS
      - "traefik.http.routers.munney-prod-backend-http.rule=Host(`munney.munne.me`) && PathPrefix(`/api`)"
      - "traefik.http.routers.munney-prod-backend-http.entrypoints=web"
      - "traefik.http.routers.munney-prod-backend-http.middlewares=munney-redirect-to-https"

      # Middleware for HTTP to HTTPS redirect (Munney-specific)
      - "traefik.http.middlewares.munney-redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.munney-redirect-to-https.redirectscheme.permanent=true"

      # Security middleware (HSTS headers)
      - "traefik.http.middlewares.munney-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.munney-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.munney-security.headers.stsPreload=true"

      # Service configuration
      - "traefik.http.services.munney-prod-backend.loadbalancer.server.port=80"

      # Project labels for easy filtering
      - "project=munney"
      - "environment=production"

  munney-prod-frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: "https://munney.munne.me/api"
    container_name: munney-prod-frontend
    restart: unless-stopped
    networks:
      - proxy
    depends_on:
      - munney-prod-backend
    # NO VOLUMES IN PRODUCTION - use the built image
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # HTTPS router
      - "traefik.http.routers.munney-prod-frontend.rule=Host(`munney.munne.me`)"
      - "traefik.http.routers.munney-prod-frontend.entrypoints=websecure"
      - "traefik.http.routers.munney-prod-frontend.tls=true"
      - "traefik.http.routers.munney-prod-frontend.tls.certresolver=le"
      - "traefik.http.routers.munney-prod-frontend.service=munney-prod-frontend"
      - "traefik.http.routers.munney-prod-frontend.middlewares=munney-security"

      # HTTP router - redirects to HTTPS
      - "traefik.http.routers.munney-prod-frontend-http.rule=Host(`munney.munne.me`)"
      - "traefik.http.routers.munney-prod-frontend-http.entrypoints=web"
      - "traefik.http.routers.munney-prod-frontend-http.middlewares=munney-redirect-to-https"

      # Service configuration
      - "traefik.http.services.munney-prod-frontend.loadbalancer.server.port=80"

      # Project labels
      - "project=munney"
      - "environment=production"

  munney-prod-mysql:
    image: mysql:8.0
    container_name: munney-prod-mysql
    restart: unless-stopped
    networks:
      - munney-prod-network
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD_PROD}
      MYSQL_DATABASE: money_db_prod
      MYSQL_USER: money
      MYSQL_PASSWORD: ${MYSQL_PASSWORD_PROD}
    volumes:
      - munney-prod-mysql-data:/var/lib/mysql
      - ../../backend/mysql-custom.cnf:/etc/mysql/conf.d/mysql-custom.cnf
      - ../../backups:/backups
    command: --default-time-zone='+00:00'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD_PROD}"]
      interval: 10s
      retries: 5
      start_period: 30s
    ports:
      - "3333:3306"  # Only for external database tools
    labels:
      - "project=munney"
      - "environment=production"

networks:
  proxy:
    external: true
  munney-prod-network:
    name: munney-prod-network
    driver: bridge

volumes:
  munney-prod-mysql-data:
    name: munney_prod_mysql_data
